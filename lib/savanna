# lib/savanna
# Functions to control the configuration and operation of the EHO service
# <do not include this template file in ``stack.sh``!>

# ``stack.sh`` calls the entry points in this order:
#
# install_svanna
# configure_savanna
# start_savanna
# stop_savanna

# Save trace setting
XTRACE=$(set +o | grep xtrace)
set +o xtrace

source $TOP_DIR/openrc

# Defaults
# --------

# <define global variables here that belong to this project>

# Set up default directories
SAVANNA_DIR=$DEST/savanna

if [[ -d $SAVANNA_DIR/bin ]]; then
    SAVANNA_BIN_DIR=$SAVANNA_DIR/bin
else
    SAVANNA_BIN_DIR=$(get_python_exec_prefix)
fi

function install_req() {
    if is_ubuntu; then
        install_package python-dev python-virtualenv
    elif is_fedora; then
        install_package python-devel python-virtualenv
    else
        exit_distro_not_supported "This OS is not support for Savanna"
    fi
}

function install_savanna() {
    git_clone $SAVANNA_REPO $SAVANNA_DIR $SAVANNA_BRANCH $SAVANNA_TAG
}

function configure_savanna() {
    setup_develop $SAVANNA_DIR
    echo "[DEFAULT]
allow_cluster_ops=true
os_auth_host=127.0.0.1
os_admin_password=$OS_PASSWORD
plugins=vanilla
[cluster_node]
use_floating_ips=false
[plugin:vanilla]
plugin_class=savanna.plugins.vanilla.plugin:VanillaProvider
[sqlalchemy]
" > $SAVANNA_DIR/etc/savanna/savanna.conf
}

function start_savanna() {
    screen_it savanna "cd $SAVANNA_DIR && tox -evenv -- savanna-api --config-file $SAVANNA_DIR/etc/savanna/savanna.conf"
}

function stop_savanna() {
    for serv in savanna; do
        screen -S $SCREEN_NAME -p $serv -X kill
    done
}

# Restore xtrace
$XTRACE

